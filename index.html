<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сравнение таблиц сайтов</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .upload-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .results {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .diff-added {
            background-color: #d4edda;
        }
        .diff-removed {
            background-color: #f8d7da;
        }
        .diff-changed {
            background-color: #fff3cd;
        }
        .url-path {
            color: #666;
            font-size: 0.9em;
        }
        .stats {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Сравнение таблиц старой и новой версий сайта</h1>
        
        <div class="upload-section">
            <h3>Загрузите CSV файлы:</h3>
            <p>Порядок важен: сначала старая версия, потом новая версия</p>
            
            <div>
                <label for="file1">Старая версия (https://groupintelcar.ru/...):</label>
                <input type="file" id="file1" accept=".csv,.xlsx,.xls">
            </div>
            
            <div>
                <label for="file2">Новая версия (http://85.143.175.74/...):</label>
                <input type="file" id="file2" accept=".csv,.xlsx,.xls">
            </div>
            
            <button id="compareBtn" disabled>Сравнить таблицы</button>
        </div>

        <div id="loading" style="display: none;">
            <p>Обработка данных... Это может занять несколько минут.</p>
        </div>

        <div id="results" class="results" style="display: none;">
            <div id="stats" class="stats"></div>
            <div id="differences"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        class TableComparator {
            constructor() {
                this.oldData = null;
                this.newData = null;
                this.columns = [
                    'Address', 'Status-Code', 'Status-Text', 'Type', 'Size', 
                    'Title', 'Date', 'Level', 'Links Out', 'Links In', 
                    'Server', 'Error', 'Duration', 'Charset', 'Description'
                ];
            }

            // Нормализация URL для сравнения
            normalizeUrl(url, isOld = true) {
                if (!url) return '';
                
                try {
                    // Убираем протокол и домен, оставляем только путь
                    const urlObj = new URL(url);
                    return urlObj.pathname + urlObj.search + urlObj.hash;
                } catch (e) {
                    // Если URL некорректный, возвращаем как есть
                    return url;
                }
            }

            // Создание карты данных по нормализованным URL
            createDataMap(data, isOld = true) {
                const map = new Map();
                
                data.forEach(row => {
                    const normalizedUrl = this.normalizeUrl(row.Address, isOld);
                    if (normalizedUrl) {
                        map.set(normalizedUrl, row);
                    }
                });
                
                return map;
            }

            // Сравнение двух значений
            compareValues(val1, val2, column) {
                if (column === 'Address') {
                    return this.normalizeUrl(val1, true) === this.normalizeUrl(val2, false);
                }
                
                // Приведение к строке для сравнения
                const str1 = String(val1 || '').trim();
                const str2 = String(val2 || '').trim();
                
                return str1 === str2;
            }

            // Основной метод сравнения
            compare(oldData, newData) {
                const oldMap = this.createDataMap(oldData, true);
                const newMap = this.createDataMap(newData, false);
                
                const differences = [];
                const stats = {
                    totalOld: oldData.length,
                    totalNew: newData.length,
                    matched: 0,
                    changed: 0,
                    onlyInOld: 0,
                    onlyInNew: 0
                };

                // Проверяем URL, которые есть в старой версии
                for (const [path, oldRow] of oldMap.entries()) {
                    const newRow = newMap.get(path);
                    
                    if (newRow) {
                        const rowDifferences = {};
                        let hasDifferences = false;

                        // Сравниваем каждую колонку
                        for (const column of this.columns) {
                            if (!this.compareValues(oldRow[column], newRow[column], column)) {
                                rowDifferences[column] = {
                                    old: oldRow[column],
                                    new: newRow[column]
                                };
                                hasDifferences = true;
                            }
                        }

                        if (hasDifferences) {
                            differences.push({
                                type: 'changed',
                                path: path,
                                oldUrl: oldRow.Address,
                                newUrl: newRow.Address,
                                differences: rowDifferences
                            });
                            stats.changed++;
                        } else {
                            stats.matched++;
                        }
                    } else {
                        differences.push({
                            type: 'only-in-old',
                            path: path,
                            oldUrl: oldRow.Address,
                            differences: { exists: 'Только в старой версии' }
                        });
                        stats.onlyInOld++;
                    }
                }

                // Проверяем URL, которые есть только в новой версии
                for (const [path, newRow] of newMap.entries()) {
                    if (!oldMap.has(path)) {
                        differences.push({
                            type: 'only-in-new',
                            path: path,
                            newUrl: newRow.Address,
                            differences: { exists: 'Только в новой версии' }
                        });
                        stats.onlyInNew++;
                    }
                }

                return { differences, stats };
            }

            // Форматирование различий для отображения
            formatDifferences(comparisonResult) {
                const { differences, stats } = comparisonResult;
                
                let html = '<h3>Статистика сравнения:</h3>';
                html += `
                    <div class="stats">
                        <p><strong>Всего URL в старой версии:</strong> ${stats.totalOld}</p>
                        <p><strong>Всего URL в новой версии:</strong> ${stats.totalNew}</p>
                        <p><strong>Полностью совпадают:</strong> ${stats.matched}</p>
                        <p><strong>Измененные URL:</strong> ${stats.changed}</p>
                        <p><strong>Только в старой версии:</strong> ${stats.onlyInOld}</p>
                        <p><strong>Только в новой версии:</strong> ${stats.onlyInNew}</p>
                    </div>
                `;

                if (differences.length === 0) {
                    html += '<p>Все данные полностью совпадают!</p>';
                    return html;
                }

                html += '<h3>Найденные различия:</h3>';

                differences.forEach(diff => {
                    let rowClass = '';
                    let title = '';

                    switch (diff.type) {
                        case 'changed':
                            rowClass = 'diff-changed';
                            title = 'Измененная страница';
                            break;
                        case 'only-in-old':
                            rowClass = 'diff-removed';
                            title = 'Только в старой версии';
                            break;
                        case 'only-in-new':
                            rowClass = 'diff-added';
                            title = 'Только в новой версии';
                            break;
                    }

                    html += `
                        <div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px; background: ${getComputedStyle(document.documentElement).getPropertyValue('--' + rowClass.replace('diff-', '')) || '#fff'};">
                            <h4>${title} - ${diff.path}</h4>
                            ${diff.oldUrl ? `<p><strong>Старый URL:</strong> ${diff.oldUrl}</p>` : ''}
                            ${diff.newUrl ? `<p><strong>Новый URL:</strong> ${diff.newUrl}</p>` : ''}
                    `;

                    if (diff.type === 'changed') {
                        html += '<table><tr><th>Колонка</th><th>Старое значение</th><th>Новое значение</th></tr>';
                        
                        for (const [column, values] of Object.entries(diff.differences)) {
                            html += `
                                <tr>
                                    <td><strong>${column}</strong></td>
                                    <td>${this.formatValue(values.old)}</td>
                                    <td>${this.formatValue(values.new)}</td>
                                </tr>
                            `;
                        }
                        
                        html += '</table>';
                    }

                    html += '</div>';
                });

                return html;
            }

            formatValue(value) {
                if (value === null || value === undefined) return '<em>пусто</em>';
                if (value === '') return '<em>пустая строка</em>';
                return String(value).substring(0, 200) + (String(value).length > 200 ? '...' : '');
            }
        }

        // Обработчики событий для загрузки файлов
        document.addEventListener('DOMContentLoaded', function() {
            const file1Input = document.getElementById('file1');
            const file2Input = document.getElementById('file2');
            const compareBtn = document.getElementById('compareBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const statsDiv = document.getElementById('stats');
            const differencesDiv = document.getElementById('differences');

            let file1Data = null;
            let file2Data = null;

            // Проверка готовности к сравнению
            function checkReady() {
                compareBtn.disabled = !(file1Data && file2Data);
            }

            // Чтение CSV файла
            function readCSV(file, callback) {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        callback(results.data);
                    },
                    error: function(error) {
                        alert('Ошибка при чтении файла: ' + error.message);
                    }
                });
            }

            // Чтение Excel файла
            function readExcel(file, callback) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        callback(jsonData);
                    } catch (error) {
                        alert('Ошибка при чтении Excel файла: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            // Обработка загрузки файлов
            file1Input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (file.name.endsWith('.csv')) {
                    readCSV(file, function(data) {
                        file1Data = data;
                        checkReady();
                    });
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    readExcel(file, function(data) {
                        file1Data = data;
                        checkReady();
                    });
                } else {
                    alert('Поддерживаются только CSV и Excel файлы');
                }
            });

            file2Input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (file.name.endsWith('.csv')) {
                    readCSV(file, function(data) {
                        file2Data = data;
                        checkReady();
                    });
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    readExcel(file, function(data) {
                        file2Data = data;
                        checkReady();
                    });
                } else {
                    alert('Поддерживаются только CSV и Excel файлы');
                }
            });

            // Обработка нажатия кнопки сравнения
            compareBtn.addEventListener('click', function() {
                if (!file1Data || !file2Data) return;

                loading.style.display = 'block';
                results.style.display = 'none';

                // Даем время на отрисовку loading
                setTimeout(function() {
                    const comparator = new TableComparator();
                    const comparisonResult = comparator.compare(file1Data, file2Data);
                    
                    differencesDiv.innerHTML = comparator.formatDifferences(comparisonResult);
                    
                    loading.style.display = 'none';
                    results.style.display = 'block';
                }, 100);
            });
        });
    </script>
</body>
</html>
